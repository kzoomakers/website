<!DOCTYPE html>

<!--
 // FACEBOOK: https://www.facebook.com/KzooMakers/
 // GITHUB: https://github.com/kzoomakers/website
-->

<html lang="en">
<head>

  <!-- Basic Page Needs
  ================================================== -->
  <meta charset="utf-8">
  <title>Calendar - Kzoo Makers</title>

  <!-- Mobile Specific Metas
  ================================================== -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Kzoo Makers events calendar - View upcoming workshops, open houses, and community events at our Kalamazoo makerspace. Join us for hands-on learning, collaboration, and maker meetups. All members and visitors welcome.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta name="author" content="Kzoo Makers">
  <meta name="generator" content="Kzoo Makers Community Website">
  <meta name="keywords" content="makerspace events, Kalamazoo workshops, maker meetups, community events, open house, hands-on learning, maker calendar, workshop schedule">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Kzoo Makers Events Calendar">
  <meta property="og:description" content="View upcoming workshops, open houses, and community events at Kzoo Makers in Kalamazoo, MI.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://kzoomakers.org/calendar.html">

  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="images/favicon.png" />

  <!-- CSS
  ================================================== -->
  <!-- Themefisher Icon font -->
  <link rel="stylesheet" href="plugins/themefisher-font/style.css">
  <!-- bootstrap.min css -->
  <link rel="stylesheet" href="plugins/bootstrap/bootstrap.min.css">
  <!-- Lightbox.min css -->
  <link rel="stylesheet" href="plugins/lightbox2/css/lightbox.min.css">
  <!-- animation css -->
  <link rel="stylesheet" href="plugins/animate/animate.css">
  <!-- Slick Carousel -->
  <link rel="stylesheet" href="plugins/slick/slick.css">
  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="css/style.css">

  <style>
    .calendar-controls {
      text-align: center;
      margin: 30px 0;
    }
    
    .calendar-controls button {
      margin: 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .calendar-controls .btn-primary {
      background-color: #47424C;
      color: white;
    }
    
    .calendar-controls .btn-primary:hover {
      background-color: #655D67;
    }
    
    .calendar-controls .btn-secondary {
      background-color: #e0e0e0;
      color: #333;
    }
    
    .calendar-controls .btn-secondary:hover {
      background-color: #d0d0d0;
    }
    
    .calendar-controls .btn-toggle {
      background-color: #5cb85c;
      color: white;
      font-weight: bold;
    }
    
    .calendar-controls .btn-toggle:hover {
      background-color: #4cae4c;
    }
    
    .date-range-inputs {
      display: inline-block;
      margin: 10px;
    }
    
    .date-range-inputs input {
      padding: 8px;
      margin: 0 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    .events-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .month-section {
      margin-bottom: 40px;
    }
    
    .month-header {
      background-color: #47424C;
      color: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: bold;
    }
    
    .event-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .event-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .event-date {
      color: #47424C;
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .event-date-text {
      flex: 1;
    }
    
    .share-button {
      background-color: #47424C;
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.2s;
      margin-left: 10px;
    }
    
    .share-button:hover {
      background-color: #655D67;
    }
    
    .share-button:active {
      background-color: #3a3640;
    }
    
    .event-time {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .event-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    
    .event-location {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
      font-style: italic;
    }
    
    .event-description {
      color: #555;
      line-height: 1.6;
      margin-top: 15px;
    }
    
    .event-description a {
      color: #47424C;
      text-decoration: underline;
    }
    
    .loading-message {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: #666;
    }
    
    .error-message {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: #d9534f;
      background-color: #f2dede;
      border-radius: 5px;
      margin: 20px;
    }
    
    .no-events-message {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: #666;
      background-color: #f9f9f9;
      border-radius: 5px;
      margin: 20px;
    }
    
    #calendar-iframe-container {
      display: none;
      text-align: center;
      margin-top: 30px;
    }
    
    #events-list-container {
      display: block;
    }
    
    .copy-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #47424C;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.3s ease;
      font-size: 16px;
      font-weight: 500;
    }
    
    .copy-notification.show {
      opacity: 1;
    }
  </style>

</head>
<body id="body">

  <!--
  Start Preloader
  ==================================== -->
  <div id="preloader">
    <div class='preloader'>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
  <!--
  End Preloader
  ==================================== -->

<!--
Fixed Navigation
==================================== -->
<header class="navigation fixed-top">
  <!-- Navigation will be dynamically loaded by navbar.js -->
</header>
<!--
End Fixed Navigation
==================================== -->

<section class="single-page-header">
	<div class="container">
		<div class="row">
			<div class="col-md-12">
				<h2>Events Calendar</h2>
				<ol class="breadcrumb header-bradcrumb justify-content-center">
					<li class="breadcrumb-item"><a href="index.html" class="text-white">Home</a></li>
					<li class="breadcrumb-item active" aria-current="page">Calendar</li>
				</ol>
			</div>
		</div>
	</div>
</section>

<!--
Start Calendar Section
==================================== -->
<section id="calendar" class="about section">
  <div class="container" data-aos="fade-up">
    <div class="row justify-content-center">
      <!-- section title -->
      <div class="col-xl-6 col-lg-8">
        <div class="title text-center">
          <h2>Upcoming Events</h2>
          <p>Check out our upcoming workshops, open houses, and community events. All members and visitors are welcome, just ring the doorbell when you arrive!</p>
          <div class="border"></div>
        </div>
      </div>
      <!-- /section title -->
    </div>

    <!-- Calendar Controls -->
    <div class="calendar-controls">
      <button id="toggle-view-btn" class="btn-toggle" onclick="toggleCalendarView()">Switch to Calendar View</button>
      <br>
      <div id="filter-controls" style="margin-top: 15px;">
        <button class="btn-primary" onclick="filterThisMonth()">This Month</button>
        <button class="btn-primary" onclick="filterNextMonth()">Next Month</button>
        <div class="date-range-inputs">
          <label>Custom Range:</label>
          <input type="date" id="start-date" />
          <span style="margin: 0 5px;">to</span>
          <input type="date" id="end-date" />
          <button class="btn-secondary" onclick="filterCustomRange()">Apply</button>
          <button class="btn-secondary" onclick="clearFilter()">Show All Upcoming</button>
        </div>
      </div>
    </div>

    <!-- Events List Container -->
    <div id="events-list-container">
      <div class="loading-message">Loading events...</div>
    </div>

    <!-- Calendar Iframe Container -->
    <div id="calendar-iframe-container">
      <div class="row justify-content-center">
        <div class="col-lg-12">
          <div style="text-align: center;">
            <iframe src="https://calendar.google.com/calendar/u/0/embed?src=kzoomakers.org_fkmebp59ti7pvl271vp65p1k8s@group.calendar.google.com&ctz=America/New_York" 
                    style="border: 0; max-width: 100%;" 
                    width="1000" 
                    height="800" 
                    frameborder="0" 
                    scrolling="no">
            </iframe>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>
<!-- End Calendar Section -->

<!--
Start Call To Action
==================================== -->
<section class="call-to-action section">
	<div class="container">
		<div class="row justify-content-center">
			<div class="col-xl-6 col-lg-8 text-center">
				<h2>Join Us at an Event</h2>
				<p>Want to attend an event or schedule a tour? We'd love to meet you!</p>
				<a href="pricing.html" class="btn btn-main">See Membership Options</a>
				<a href="tour-form-redirect.html" class="btn btn-main">Schedule a Tour</a>
			</div>
		</div> <!-- End row -->
	</div> <!-- End container -->
</section> <!-- End section -->

<footer id="footer" class="bg-one">
  <!-- Footer will be dynamically loaded by footer.js -->
</footer> <!-- end footer -->


<!-- end Footer Area
========================================== -->

<!-- 
    Essential Scripts
    =====================================-->
<!-- Main jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>

<!-- Bootstrap4 -->
<script src="plugins/bootstrap/bootstrap.min.js"></script>
<!-- Parallax -->
<script src="plugins/parallax/jquery.parallax-1.1.3.js"></script>
<!-- lightbox -->
<script src="plugins/lightbox2/js/lightbox.min.js"></script>
<!-- Owl Carousel -->
<script src="plugins/slick/slick.min.js"></script>
<!-- filter -->
<script src="plugins/filterizr/jquery.filterizr.min.js"></script>
<!-- Smooth Scroll js -->
<script src="plugins/smooth-scroll/smooth-scroll.min.js"></script>
<!-- Google Map -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcABaamniA6OL5YvYSpB3pFMNrXwXnLwU"></script>
<script src="plugins/google-map/gmap.js"></script>

<!-- Dynamic Navigation -->
<script src="dynamic/js/navbar.js"></script>

<!-- Dynamic Footer -->
<script src="dynamic/js/footer.js"></script>

<!-- Dynamic Hours -->
<script src="dynamic/js/hours.js"></script>

<!-- Dynamic Counters -->
<script src="dynamic/js/counters.js"></script>

<!-- Custom js -->
<script src="js/script.js"></script>

<!-- Calendar ICS Parser and Display -->
<script>
  let allEvents = [];
  let currentView = 'list'; // 'list' or 'iframe'

  // Parse ICS date format
  function parseICSDate(dateStr, isAllDay = false) {
    if (!dateStr) return null;
    
    // Remove TZID if present and get the actual date string
    const parts = dateStr.split(':');
    dateStr = parts[parts.length - 1];
    
    // Format: YYYYMMDDTHHMMSSZ or YYYYMMDD
    const year = parseInt(dateStr.substring(0, 4));
    const month = parseInt(dateStr.substring(4, 6)) - 1;
    const day = parseInt(dateStr.substring(6, 8));
    
    if (dateStr.length === 8 || isAllDay) {
      // All-day event - use local midnight
      return new Date(year, month, day, 0, 0, 0);
    }
    
    const hour = parseInt(dateStr.substring(9, 11));
    const minute = parseInt(dateStr.substring(11, 13));
    const second = parseInt(dateStr.substring(13, 15));
    
    if (dateStr.endsWith('Z')) {
      // UTC time - create UTC date and it will be displayed in local time
      return new Date(Date.UTC(year, month, day, hour, minute, second));
    }
    
    // Local time
    return new Date(year, month, day, hour, minute, second);
  }

  // Parse RRULE for recurring events
  function parseRRule(rrule) {
    const rules = {};
    rrule.split(';').forEach(part => {
      const [key, value] = part.split('=');
      rules[key] = value;
    });
    return rules;
  }

  // Generate recurring event instances
  function generateRecurringInstances(event, rrule, startDate, endDate) {
    const instances = [];
    const rules = parseRRule(rrule);
    
    const freq = rules.FREQ;
    const until = rules.UNTIL ? parseICSDate(rules.UNTIL) : new Date(Date.now() + 365 * 24 * 60 * 60 * 1000);
    const count = rules.COUNT ? parseInt(rules.COUNT) : null;
    
    let currentDate = new Date(startDate);
    let instanceCount = 0;
    
    // Use start of today for comparison to include all events happening today
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    while (currentDate <= until && currentDate <= new Date(Date.now() + 365 * 24 * 60 * 60 * 1000)) {
      if (count && instanceCount >= count) break;
      
      if (currentDate >= today) {
        const duration = endDate - startDate;
        const instanceEnd = new Date(currentDate.getTime() + duration);
        
        instances.push({
          ...event,
          start: new Date(currentDate),
          end: instanceEnd
        });
        
        instanceCount++;
      }
      
      // Increment based on frequency
      if (freq === 'DAILY') {
        currentDate.setDate(currentDate.getDate() + 1);
      } else if (freq === 'WEEKLY') {
        currentDate.setDate(currentDate.getDate() + 7);
      } else if (freq === 'MONTHLY') {
        currentDate.setMonth(currentDate.getMonth() + 1);
      } else if (freq === 'YEARLY') {
        currentDate.setFullYear(currentDate.getFullYear() + 1);
      } else {
        break;
      }
    }
    
    return instances;
  }

  // Parse ICS content
  function parseICS(icsContent) {
    const events = [];
    const lines = icsContent.split(/\r?\n/);
    let currentEvent = null;
    let currentField = '';
    const now = new Date();
    now.setHours(0, 0, 0, 0); // Start of today
    
    for (let i = 0; i < lines.length; i++) {
      let line = lines[i];
      
      // Handle line continuation (lines starting with space or tab)
      if ((line.startsWith(' ') || line.startsWith('\t')) && currentField) {
        // Remove the leading space/tab and append to current field
        currentEvent[currentField] += line.substring(1);
        continue;
      }
      
      // Now trim the line for normal processing
      line = line.trim();
      
      if (line === 'BEGIN:VEVENT') {
        currentEvent = {};
      } else if (line === 'END:VEVENT' && currentEvent) {
        // Parse dates
        const dtstart = currentEvent.DTSTART || '';
        const dtend = currentEvent.DTEND || '';
        const isAllDay = !dtstart.includes('T');
        
        const startDate = parseICSDate(dtstart, isAllDay);
        const endDate = parseICSDate(dtend, isAllDay);
        
        if (startDate) {
          // For non-recurring events, skip past events
          // For recurring events, let generateRecurringInstances handle the filtering
          if (!currentEvent.RRULE && startDate < now) {
            currentEvent = null;
            currentField = '';
            continue;
          }
          
          const event = {
            title: currentEvent.SUMMARY || 'Untitled Event',
            start: startDate,
            end: endDate || startDate,
            description: currentEvent.DESCRIPTION || '',
            location: currentEvent.LOCATION || '',
            isAllDay: isAllDay
          };
          
          // Handle recurring events (but not RECURRENCE-ID exceptions which are single instances)
          if (currentEvent.RRULE && !currentEvent['RECURRENCE-ID']) {
            const instances = generateRecurringInstances(event, currentEvent.RRULE, startDate, endDate);
            events.push(...instances);
          } else {
            // Single event or recurrence exception
            events.push(event);
          }
        }
        
        currentEvent = null;
        currentField = '';
      } else if (currentEvent && line.includes(':')) {
        const colonIndex = line.indexOf(':');
        const field = line.substring(0, colonIndex).split(';')[0];
        const value = line.substring(colonIndex + 1);
        
        currentEvent[field] = value;
        currentField = field;
      }
    }
    
    return events;
  }

  // Format date for display
  function formatDate(date) {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
  }

  // Format time for display
  function formatTime(date) {
    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
  }

  // Clean ICS text values (unescape and unfold)
  function cleanICSText(text) {
    if (!text) return '';
    
    // Unescape backslash-escaped characters (like \, and \n and \\)
    // Order matters: do \\ first, then others
    text = text.replace(/\\\\/g, '\x00'); // Temporarily replace \\ with null char
    text = text.replace(/\\n/g, '\n');
    text = text.replace(/\\,/g, ',');
    text = text.replace(/\\;/g, ';');
    text = text.replace(/\x00/g, '\\'); // Restore single backslashes
    
    return text.trim();
  }

  // Clean HTML from description
  function cleanDescription(desc) {
    if (!desc) return '';
    
    // First clean ICS escapes
    desc = cleanICSText(desc);
    
    // Convert <br> tags to newlines
    desc = desc.replace(/<br\s*\/?>/gi, '\n');
    
    // Preserve links but clean other HTML
    desc = desc.replace(/<a\s+href="([^"]+)"[^>]*>([^<]+)<\/a>/gi, '<a href="$1" target="_blank">$2</a>');
    
    // Remove other HTML tags
    desc = desc.replace(/<[^>]+>/g, '');
    
    // Decode HTML entities
    const textarea = document.createElement('textarea');
    textarea.innerHTML = desc;
    desc = textarea.value;
    
    // Convert URLs to links if not already linked
    desc = desc.replace(/(?<!href=")(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>');
    
    return desc;
  }

  // Group events by month
  function groupEventsByMonth(events) {
    const grouped = {};
    
    events.forEach(event => {
      const monthKey = `${event.start.getFullYear()}-${String(event.start.getMonth() + 1).padStart(2, '0')}`;
      const monthName = event.start.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
      
      if (!grouped[monthKey]) {
        grouped[monthKey] = {
          name: monthName,
          events: []
        };
      }
      
      grouped[monthKey].events.push(event);
    });
    
    return grouped;
  }

  // Store events data for button access
  const eventDataMap = new Map();

  // Display events
  function displayEvents(events) {
    const container = document.getElementById('events-list-container');
    
    if (events.length === 0) {
      container.innerHTML = '<div class="no-events-message">No events found for the selected date range.</div>';
      return;
    }
    
    // Clear previous event data
    eventDataMap.clear();
    
    // Sort events by date
    events.sort((a, b) => a.start - b.start);
    
    // Group by month
    const groupedEvents = groupEventsByMonth(events);
    
    let html = '<div class="events-container">';
    
    Object.keys(groupedEvents).sort().forEach(monthKey => {
      const month = groupedEvents[monthKey];
      
      html += `<div class="month-section">`;
      html += `<div class="month-header">${month.name}</div>`;
      
      month.events.forEach((event, index) => {
        const dateStr = formatDate(event.start);
        const timeStr = event.isAllDay ? 'All Day' : `${formatTime(event.start)} - ${formatTime(event.end)}`;
        const description = cleanDescription(event.description);
        const location = cleanICSText(event.location);
        
        // Create a unique ID for the event based on title and date
        const eventId = `event-${event.start.getTime()}-${index}`;
        
        // Store event data for button access
        eventDataMap.set(eventId, {
          title: event.title,
          start: event.start,
          end: event.end,
          description: event.description,
          location: event.location,
          isAllDay: event.isAllDay
        });
        
        html += `
          <div class="event-card" id="${eventId}">
            <div class="event-date">
              <span class="event-date-text">${dateStr}</span>
              <button class="share-button" onclick="addToCalendar('${eventId}')" title="Add to your calendar">
                üìÖ Add
              </button>
              <button class="share-button" onclick="copyEventLink('${eventId}')" title="Copy link to clipboard">
                üìã Copy
              </button>
              <button class="share-button" onclick="shareEvent('${eventId}')" title="Share this event">
                üîó Share
              </button>
            </div>
            <div class="event-time">${timeStr}</div>
            <div class="event-title">${event.title}</div>
            ${location ? `<div class="event-location">üìç ${location}</div>` : ''}
            ${description ? `<div class="event-description">${description}</div>` : ''}
          </div>
        `;
      });
      
      html += `</div>`;
    });
    
    html += '</div>';
    container.innerHTML = html;
  }

  // Filter events by date range
  function filterEvents(startDate, endDate) {
    return allEvents.filter(event => {
      return event.start >= startDate && event.start <= endDate;
    });
  }

  // Filter: This Month
  function filterThisMonth() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
    
    const filtered = filterEvents(start, end);
    displayEvents(filtered);
  }

  // Filter: Next Month
  function filterNextMonth() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    const end = new Date(now.getFullYear(), now.getMonth() + 2, 0, 23, 59, 59);
    
    const filtered = filterEvents(start, end);
    displayEvents(filtered);
  }

  // Filter: Custom Range
  function filterCustomRange() {
    const startInput = document.getElementById('start-date').value;
    const endInput = document.getElementById('end-date').value;
    
    if (!startInput || !endInput) {
      alert('Please select both start and end dates');
      return;
    }
    
    const start = new Date(startInput);
    const end = new Date(endInput);
    end.setHours(23, 59, 59);
    
    if (start > end) {
      alert('Start date must be before end date');
      return;
    }
    
    const filtered = filterEvents(start, end);
    displayEvents(filtered);
  }

  // Clear filter and show all upcoming events
  function clearFilter() {
    const now = new Date();
    const upcoming = allEvents.filter(event => event.start >= now);
    displayEvents(upcoming);
  }

  // Toggle between list and iframe view
  function toggleCalendarView() {
    const listContainer = document.getElementById('events-list-container');
    const iframeContainer = document.getElementById('calendar-iframe-container');
    const toggleBtn = document.getElementById('toggle-view-btn');
    const filterControls = document.getElementById('filter-controls');
    
    if (currentView === 'list') {
      listContainer.style.display = 'none';
      iframeContainer.style.display = 'block';
      filterControls.style.display = 'none';
      toggleBtn.textContent = 'Switch to List View';
      currentView = 'iframe';
    } else {
      listContainer.style.display = 'block';
      iframeContainer.style.display = 'none';
      filterControls.style.display = 'block';
      toggleBtn.textContent = 'Switch to Calendar View';
      currentView = 'list';
    }
  }

  // Fetch and parse calendar
  async function loadCalendar() {
    const container = document.getElementById('events-list-container');
    
    try {
      // Use a CORS proxy to fetch the ICS file
      const response = await fetch('https://kzoomakers.org/cal.ics');
      
      if (!response.ok) {
        throw new Error('Failed to fetch calendar');
      }
      
      const icsContent = await response.text();
      allEvents = parseICS(icsContent);
      
      // Filter to show current month + next 5 months by default (excluding past events)
      const now = new Date();
      now.setHours(0, 0, 0, 0); // Start of today
      
      const endDate = new Date(now.getFullYear(), now.getMonth() + 6, 0, 23, 59, 59, 999);
      // This creates a date at the last day of the month that is 5 months from now
      // (month + 6 with day 0 = last day of month + 5)
      
      // Filter out past events and events beyond our date range
      const filtered = allEvents.filter(event => {
        const eventDate = new Date(event.start);
        return eventDate >= now && eventDate <= endDate;
      });
      
      console.log(`Showing ${filtered.length} events from ${now.toLocaleDateString()} to ${endDate.toLocaleDateString()}`);
      
      displayEvents(filtered);
      
    } catch (error) {
      console.error('Error loading calendar:', error);
      container.innerHTML = `
        <div class="error-message">
          <strong>Unable to load calendar events right now.</strong><br>
          Please try refreshing the page or switch to Calendar View to see events.
        </div>
      `;
    }
  }

  // Show notification toast
  function showNotification(message) {
    // Remove any existing notification
    const existing = document.querySelector('.copy-notification');
    if (existing) {
      existing.remove();
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = 'copy-notification';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Trigger fade in
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);
    
    // Fade out and remove after 3 seconds
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        notification.remove();
      }, 300);
    }, 3000);
  }
  
  // Format date for ICS file
  function formatICSDate(date, isAllDay = false) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    if (isAllDay) {
      return `${year}${month}${day}`;
    }
    
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    
    return `${year}${month}${day}T${hours}${minutes}${seconds}`;
  }
  
  // Add to calendar function - generates ICS file
  function addToCalendar(eventId) {
    const event = eventDataMap.get(eventId);
    if (!event) return;
    
    const startDate = formatICSDate(event.start, event.isAllDay);
    const endDate = formatICSDate(event.end, event.isAllDay);
    const now = formatICSDate(new Date());
    
    // Escape special characters for ICS format
    const escapeICS = (str) => {
      return str.replace(/\\/g, '\\\\')
                .replace(/;/g, '\\;')
                .replace(/,/g, '\\,')
                .replace(/\n/g, '\\n');
    };
    
    const icsContent = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//Kzoo Makers//Calendar//EN',
      'BEGIN:VEVENT',
      `UID:${eventId}@kzoomakers.org`,
      `DTSTAMP:${now}`,
      `DTSTART:${startDate}`,
      `DTEND:${endDate}`,
      `SUMMARY:${escapeICS(event.title)}`,
      event.location ? `LOCATION:${escapeICS(event.location)}` : '',
      event.description ? `DESCRIPTION:${escapeICS(event.description)}` : '',
      'END:VEVENT',
      'END:VCALENDAR'
    ].filter(line => line).join('\r\n');
    
    // Create blob and download
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${event.title.replace(/[^a-z0-9]/gi, '_')}.ics`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
    
    showNotification('üìÖ Calendar file downloaded!');
  }
  
  // Copy event link directly to clipboard
  function copyEventLink(eventId) {
    const url = `${window.location.origin}${window.location.pathname}#${eventId}`;
    copyToClipboard(url);
  }
  
  // Share event function with event details
  function shareEvent(eventId) {
    const event = eventDataMap.get(eventId);
    const url = `${window.location.origin}${window.location.pathname}#${eventId}`;
    
    if (!event) {
      copyToClipboard(url);
      return;
    }
    
    // Format the date nicely
    const dateStr = formatDate(event.start);
    const shareText = `Check out the Kzoo Makers meeting "${event.title}" on ${dateStr} at ${url}`;
    
    // Try to use the Web Share API if available (mobile devices)
    if (navigator.share) {
      navigator.share({
        title: `Kzoo Makers: ${event.title}`,
        text: shareText,
        url: url
      }).catch(err => {
        // If share fails or is cancelled, fall back to copying to clipboard
        if (err.name !== 'AbortError') {
          copyToClipboard(url);
        }
      });
    } else {
      // Fall back to copying to clipboard (desktop)
      copyToClipboard(url);
    }
  }
  
  // Copy URL to clipboard
  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        showNotification('üîó Link copied to clipboard!');
      }).catch(err => {
        // Fallback for older browsers
        fallbackCopyToClipboard(text);
      });
    } else {
      fallbackCopyToClipboard(text);
    }
  }
  
  // Fallback copy method for older browsers
  function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      document.execCommand('copy');
      showNotification('üîó Link copied to clipboard!');
    } catch (err) {
      showNotification('‚ùå Unable to copy link');
    }
    
    document.body.removeChild(textArea);
  }
  
  // Scroll to event if hash is present in URL
  function scrollToEventIfNeeded() {
    if (window.location.hash) {
      const eventId = window.location.hash.substring(1);
      const element = document.getElementById(eventId);
      
      if (element) {
        setTimeout(() => {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          element.style.backgroundColor = '#fff3cd';
          setTimeout(() => {
            element.style.transition = 'background-color 1s ease';
            element.style.backgroundColor = 'white';
          }, 1000);
        }, 500);
      }
    }
  }

  // Load calendar when page loads
  document.addEventListener('DOMContentLoaded', () => {
    loadCalendar().then(() => {
      scrollToEventIfNeeded();
    });
  });
</script>

</body>

</html>